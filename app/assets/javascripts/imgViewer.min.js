/*! jQuery imgViewer - v0.9.0 - 2016-08-09
* https://github.com/waynegm/imgViewer
* Copyright (c) 2016 Wayne Mogg; Licensed MIT */
!function(a){a.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,zoomable:!0,dragable:!0,onClick:null,onUpdate:null},_create:function(){var b=this;this.element.is("img")||a.error("imgviewer plugin can only be applied to img elements"),b.img=b.element[0];var c=a(b.img);b.zimg=a("<img/>",{src:b.img.src}).appendTo("body").wrap("<div class='viewport'/>");var d=a(b.zimg);b.view=a(b.zimg).parent();var e=a(b.view);b.vCenter={},b.drag=!1,b.pinch=!1,b.ready=!1,c.one("load",function(){b.ready=!0;var a=c.width(),f=c.height(),g=c.offset();b.offsetPadding={top:parseInt(c.css("padding-top"),10),left:parseInt(c.css("padding-left"),10),right:parseInt(c.css("padding-right"),10),bottom:parseInt(c.css("padding-bottom"),10)},b.offsetBorder={x:Math.round((c.outerWidth()-c.innerWidth())/2),y:Math.round((c.outerHeight()-c.innerHeight())/2)};var h=g.top+b.offsetBorder.y+b.offsetPadding.top,i=g.left+b.offsetBorder.x+b.offsetPadding.left;e.css({position:"absolute",overflow:"hidden",top:h+"px",left:i+"px",width:a+"px",height:f+"px"}),d.css({position:"relative",top:"0px",left:"0px",width:a+"px",height:f+"px","-webkit-tap-highlight-color":"transparent"}),b.vCenter={x:a/2,y:f/2},b.update()}).each(function(){this.complete&&a(this).load()}),b.render=!1,d.hammer(),b.options.zoomable&&b._bind_zoom_events(),b.options.dragable&&b._bind_drag_events(),d.on("tap",function(a){a.preventDefault(),b.dragging||(a.pageX=a.gesture.center.x+window.scrollX,a.pageY=a.gesture.center.y+window.scrollY,b._trigger("onClick",a,b))}),a(window).resize(function(){b.ready&&(b.vCenter.x*=c.width()/e.width(),b.vCenter.y*=c.height()/e.height(),b.update())})},_bind_zoom_events:function(){function b(){e.render||(e.render=!0,d())}function c(){e.render=!1}function d(){e.render&&(window.requestAnimationFrame(d),e.update())}var e=this,f=a(e.zimg);f.on("mousewheel",function(a){a.preventDefault();var b=a.deltaY;e.options.zoom-=b*e.options.zoomStep,e.update()}),f.data("hammer").recognizers[1].options.enable=!0,f.on("pinchstart",function(){}),f.on("pinch",function(a){if(a.preventDefault(),e.pinch){e.options.zoom=a.gesture.scale*e.pinchstart_scale;var c=e.imgToCursor(e.pinchstartrelpos.x,e.pinchstartrelpos.y);e.vCenter.x=e.vCenter.x+(c.x-e.pinchstart.x)/e.options.zoom,e.vCenter.y=e.vCenter.y+(c.y-e.pinchstart.y)/e.options.zoom}else e.pinchstart={x:a.gesture.center.x+window.scrollX,y:a.gesture.center.y+window.scrollY},e.pinchstartrelpos=e.cursorToImg(e.pinchstart.x,e.pinchstart.y),e.pinchstart_scale=e.options.zoom,b(),e.pinch=!0}),f.on("pinchend",function(a){a.preventDefault(),e.pinch&&(c(),e.update(),e.pinch=!1)})},_bind_drag_events:function(){function b(){e.render||(e.render=!0,d())}function c(){e.render=!1}function d(){e.render&&(window.requestAnimationFrame(d),e.update())}var e=this,f=a(e.zimg);f.on("pan",function(a){a.preventDefault(),e.drag?(e.vCenter.x=e.dragXorg-a.gesture.deltaX/e.options.zoom,e.vCenter.y=e.dragYorg-a.gesture.deltaY/e.options.zoom):(e.drag=!0,e.dragXorg=e.vCenter.x,e.dragYorg=e.vCenter.y,b())}),f.on("panend",function(a){a.preventDefault(),e.drag&&(e.drag=!1,c(),e.update())})},_unbind_zoom_events:function(){var b=this,c=a(b.zimg);c.data("hammer").recognizers[1].options.enable=!1,c.off("mousewheel"),c.off("pinchstart"),c.off("pinch"),c.off("pinchend")},_unbind_drag_events:function(){var b=this,c=a(b.zimg);c.off("pan"),c.off("panend")},destroy:function(){var b=a(this.zimg);b.unbind("click"),a(window).unbind("resize"),b.remove(),a(this.view).remove(),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){switch(b){case"zoom":if(parseFloat(c)<1||isNaN(parseFloat(c)))return;break;case"zoomStep":if(parseFloat(c)<=0||isNaN(parseFloat(c)))return}var d=a.ui.version.split(".");switch(d[0]>1||d[1]>8?this._super(b,c):a.Widget.prototype._setOption.apply(this,arguments),b){case"zoom":this.ready&&this.update();break;case"zoomable":this.options.zoomable?this._bind_zoom_events():this._unbind_zoom_events();break;case"dragable":this.options.dragable?this._bind_drag_events():this._unbind_drag_events()}},addElem:function(b){a(this.view).append(b)},isVisible:function(a,b){var c=this.getView();return c?a>=c.left&&a<=c.right&&b>=c.top&&b<=c.bottom:!1},getView:function(){if(this.ready){var b=a(this.img),c=b.width(),d=b.height(),e=this.options.zoom;return{top:this.vCenter.y/d-.5/e,left:this.vCenter.x/c-.5/e,bottom:this.vCenter.y/d+.5/e,right:this.vCenter.x/c+.5/e}}return null},panTo:function(b,c){if(this.ready&&b>=0&&1>=b&&c>=0&&1>=c){var d=a(this.img),e=d.width(),f=d.height();return this.vCenter.x=b*e,this.vCenter.y=c*f,this.update(),{x:this.vCenter.x/e,y:this.vCenter.y/f}}return null},imgToView:function(b,c){if(this.ready&&b>=0&&1>=b&&c>=0&&1>=c){var d=a(this.img),e=d.width(),f=d.height(),g=e/2-this.vCenter.x*this.options.zoom,h=f/2-this.vCenter.y*this.options.zoom,i=b*e*this.options.zoom+g,j=c*f*this.options.zoom+h;return{x:Math.round(i),y:Math.round(j)}}return null},imgToCursor:function(b,c){var d=this.imgToView(b,c);if(d){var e=a(this.img).offset();return d.x+=e.left+this.offsetBorder.x+this.offsetPadding.left,d.y+=e.top+this.offsetBorder.y+this.offsetPadding.top,d}return null},viewToImg:function(b,c){if(this.ready){var d=a(this.img),e=d.width(),f=d.height(),g=e/2-this.vCenter.x*this.options.zoom,h=f/2-this.vCenter.y*this.options.zoom,i=(b-g)/(e*this.options.zoom),j=(c-h)/(f*this.options.zoom);return i>=0&&1>=i&&j>=0&&1>=j?{x:i,y:j}:null}return null},cursorToImg:function(b,c){if(this.ready){var d=a(this.img),e=d.width(),f=d.height(),g=d.offset(),h=e/2-this.vCenter.x*this.options.zoom,i=f/2-this.vCenter.y*this.options.zoom,j=(b-g.left-this.offsetBorder.x-this.offsetPadding.left-h)/(e*this.options.zoom),k=(c-g.top-this.offsetBorder.y-this.offsetPadding.top-i)/(f*this.options.zoom);return j>=0&&1>=j&&k>=0&&1>=k?{x:j,y:k}:null}return null},update:function(){if(this.ready){var b,c,d,e,f=a(this.img),g=f.width(),h=f.height(),i=f.offset(),j=this.options.zoom,k=g/2,l=h/2;1>=j?(b=0,c=0,d=g,e=h,this.vCenter={x:k,y:l},this.options.zoom=1,j=1):(b=Math.round(l-this.vCenter.y*j),c=Math.round(k-this.vCenter.x*j),d=Math.round(g*j),e=Math.round(h*j),c>0?(this.vCenter.x=k/j,c=0):g>c+d&&(this.vCenter.x=g-k/j,c=g-d),b>0?(this.vCenter.y=l/j,b=0):h>b+e&&(this.vCenter.y=h-l/j,b=h-e));var m=Math.round(i.top+this.offsetBorder.y+this.offsetPadding.top),n=Math.round(i.left+this.offsetBorder.x+this.offsetPadding.left);a(this.view).css({top:m+"px",left:n+"px",width:g+"px",height:h+"px"}),a(this.zimg).css({width:g+"px",height:h+"px"});var o=-(this.vCenter.x-k)*j,p=-(this.vCenter.y-l)*j;a(this.zimg).css({transform:"translate("+o+"px,"+p+"px) scale("+j+","+j+")"}),this._trigger("onUpdate",null,this)}}})}(jQuery);